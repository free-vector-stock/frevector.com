<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ADMIN | Bulk Upload Engine</title>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; padding: 50px; }
        .box { max-width: 800px; margin: 0 auto; background: #111; padding: 40px; border: 1px solid #333; }
        input, select { width: 100%; padding: 15px; margin: 10px 0; background: #000; border: 1px solid #444; color: #fff; }
        .drop-zone { border: 2px dashed #444; padding: 60px; text-align: center; margin-bottom: 20px; cursor: pointer; }
        .drop-zone:hover { border-color: #fff; }
        button { width: 100%; padding: 20px; background: #fff; color: #000; font-weight: bold; border: none; cursor: pointer; font-size: 16px; }
        button:disabled { background: #444; cursor: not-allowed; }
        #log { background: #000; color: #0f0; padding: 15px; font-family: monospace; height: 200px; overflow-y: auto; margin-top: 20px; border: 1px solid #333; }
    </style>
</head>
<body>

<div class="box">
    <h1>CLOUD STOCK MANAGER</h1>
    <p style="color: #666; margin-bottom: 30px;">Upload JPG, EPS, SVG, and JSON files simultaneously. Folders are auto-detected by filename.</p>
    
    <input type="password" id="token" placeholder="GitHub Personal Access Token">
    
    <div class="drop-zone" onclick="document.getElementById('files').click()">
        <strong>SELECT BATCH FILES</strong>
        <p>Unlimited files, automatic naming match.</p>
    </div>
    <input type="file" id="files" multiple style="display:none" onchange="preview()">

    <button id="upBtn" onclick="startUpload()">SYNC TO CLOUD STORAGE</button>

    <div id="log">Ready for session...</div>
</div>

<script>
    const G_USER = "free-vector-stock", G_REPO = "free-vector-stock";
    const cats = ["Abstract","Animals/Wildlife","The Arts","Backgrounds/Textures","Beauty/Fashion","Buildings/Landmarks","Business/Finance","Celebrities","Education","Food","Drink","Healthcare/Medical","Holidays","Industrial","Interiors","Miscellaneous","Nature","Objects","Parks/Outdoor","People","Religion","Science","Signs/Symbols","Sports/Recreation","Technology","Transportation","Vintage","Logo","Font","Icon"];

    function addLog(m) {
        const l = document.getElementById('log');
        l.innerHTML += `> ${m}<br>`;
        l.scrollTop = l.scrollHeight;
    }

    function preview() {
        const count = document.getElementById('files').files.length;
        addLog(`Found ${count} files in queue.`);
    }

    async function startUpload() {
        const token = document.getElementById('token').value;
        const fileList = Array.from(document.getElementById('files').files);
        if(!token || fileList.length === 0) { alert("Token and Files required!"); return; }

        const btn = document.getElementById('upBtn');
        btn.disabled = true;
        addLog("Accessing GitHub Tree API...");

        try {
            const head = await fetch(`https://api.github.com/repos/${G_USER}/${G_REPO}/git/refs/heads/main`, {
                headers: { 'Authorization': `token ${token}` }
            }).then(r => r.json());
            const baseSha = head.object.sha;

            const treeEntries = [];
            for(let f of fileList) {
                let folder = "Miscellaneous";
                const nameLow = f.name.toLowerCase();
                for(let c of cats) {
                    if(nameLow.includes(c.toLowerCase().split('/')[0])) { folder = c; break; }
                }

                const b64 = await toB64(f);
                const blob = await fetch(`https://api.github.com/repos/${G_USER}/${G_REPO}/git/blobs`, {
                    method: 'POST',
                    headers: { 'Authorization': `token ${token}` },
                    body: JSON.stringify({ content: b64, encoding: 'base64' })
                }).then(r => r.json());

                treeEntries.push({
                    path: `assets/${folder}/${f.name}`,
                    mode: "100644",
                    type: "blob",
                    sha: blob.sha
                });
                addLog(`Blob Created: ${f.name} in ${folder}`);
            }

            const newTree = await fetch(`https://api.github.com/repos/${G_USER}/${G_REPO}/git/trees`, {
                method: 'POST',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ base_tree: baseSha, tree: treeEntries })
            }).then(r => r.json());

            const commit = await fetch(`https://api.github.com/repos/${G_USER}/${G_REPO}/git/commits`, {
                method: 'POST',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: `System: Batch sync ${fileList.length} assets`, tree: newTree.sha, parents: [baseSha] })
            }).then(r => r.json());

            await fetch(`https://api.github.com/repos/${G_USER}/${G_REPO}/git/refs/heads/main`, {
                method: 'PATCH',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ sha: commit.sha })
            });

            addLog("SUCCESS: ALL FILES SYNCED TO REPOSITORY!");
            alert("Upload Successful. Your site will update in a few moments.");
        } catch(e) {
            addLog("ERROR: " + e.message);
        }
        btn.disabled = false;
    }

    const toB64 = file => new Promise((res, rej) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => res(reader.result.split(',')[1]);
        reader.onerror = e => rej(e);
    });
</script>
</body>
</html>
