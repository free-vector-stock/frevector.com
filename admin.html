<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ADMIN - FREE VECTOR STOCK</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body{font-family:'Segoe UI',Arial,sans-serif;background:#f0f2f5;margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh}
        .container{background:#fff;padding:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.1);width:100%;max-width:600px}
        h2{text-align:center;margin-bottom:25px;color:#1a1a1a;border-bottom:2px solid #000;padding-bottom:10px}
        input,button,select{width:100%;padding:14px;margin-bottom:15px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box}
        button{background:#000;color:#fff;font-weight:bold;cursor:pointer;border:none;transition:0.3s}
        button:hover{background:#333}
        button:disabled{background:#ccc;cursor:not-allowed}
        #status{max-height:250px;overflow-y:auto;background:#fafafa;padding:15px;border-radius:6px;font-size:12px;border:1px solid #eee}
        .success{color:#27ae60;font-weight:bold;margin-bottom:5px} 
        .error{color:#e74c3c;font-weight:bold;margin-bottom:5px}
        .info{font-size:11px;color:#666;text-align:center;margin-bottom:10px}
        .progress-item { border-bottom: 1px solid #eee; padding: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h2>STOCK MULTI-UPLOAD PANEL</h2>
        <p class="info">Select JPG, ZIP, and JSON files with identical names together.</p>
        <input type="password" id="token" placeholder="GitHub Personal Access Token">
        <input type="file" id="fileInput" multiple>
        <button id="uploadBtn" onclick="startUpload()">START MULTI-UPLOAD & UPDATE DB</button>
        <div id="status">Ready...</div>
    </div>

<script>
const repo = "free-vector-stock/free-vector-stock";
const cats = ["Abstract","Animals/Wildlife","The Arts","Backgrounds/Textures","Beauty/Fashion","Buildings/Landmarks","Business/Finance","Celebrities","Education","Food","Drink","Healthcare/Medical","Holidays","Industrial","Interiors","Miscellaneous","Nature","Objects","Parks/Outdoor","People","Religion","Science","Signs/Symbols","Sports/Recreation","Technology","Transportation","Vintage","Logo","Font","Icon"];

function getCat(filename){
    let prefix = filename.split('-')[0].toLowerCase();
    let found = cats.find(c => c.toLowerCase().replace(/[^a-z]/g,"").includes(prefix));
    return found || "Miscellaneous";
}

async function startUpload() {
    const token = document.getElementById('token').value;
    const files = Array.from(document.getElementById('fileInput').files);
    const status = document.getElementById('status');
    const btn = document.getElementById('uploadBtn');
    
    if(!token || files.length === 0) { alert("Token and files required!"); return; }
    
    btn.disabled = true;
    btn.innerText = "UPLOADING...";
    status.innerHTML = "Starting upload process...<br>";

    let newEntries = [];

    // Önce dosyaları yükle
    for (let file of files) {
        const cat = getCat(file.name);
        const path = `assets/${cat}/${file.name}`;
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'progress-item';
        itemDiv.innerText = `Processing: ${file.name}...`;
        status.appendChild(itemDiv);
        status.scrollTop = status.scrollHeight;
        
        try {
            const content = await toBase64(file);
            const sha = await getSha(path, token);
            
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                method: "PUT",
                headers: { 
                    "Authorization": `token ${token}`, 
                    "Content-Type": "application/json",
                    "Accept": "application/vnd.github.v3+json"
                },
                body: JSON.stringify({
                    message: `Upload ${file.name} to ${cat}`,
                    content: content,
                    sha: sha || undefined
                })
            });

            if(res.ok) {
                itemDiv.innerHTML = `<span class="success">✓ Uploaded: ${file.name} to ${cat}</span>`;
                
                // Eğer JPG ise database için hazırla
                if(file.name.toLowerCase().endsWith('.jpg')) {
                    const baseName = file.name.replace(/\.[^/.]+$/, "");
                    // Aynı isimli JSON dosyasını bulmaya çalış
                    const jsonFile = files.find(f => f.name === baseName + ".json");
                    let meta = { description: "", keywords: "" };
                    
                    if(jsonFile) {
                        try {
                            const jsonText = await jsonFile.text();
                            const parsed = JSON.parse(jsonText);
                            meta.description = parsed.description || "";
                            meta.keywords = parsed.keywords || "";
                        } catch(e) { console.error("JSON parse error", e); }
                    }

                    newEntries.push({
                        name: baseName,
                        category: cat,
                        description: meta.description || "Professional stock vector for commercial use.",
                        keywords: meta.keywords || "vector, free, stock",
                        date: new Date().toISOString().split('T')[0]
                    });
                }
            } else {
                const errData = await res.json();
                throw new Error(errData.message || "Upload failed");
            }
        } catch (e) {
            itemDiv.innerHTML = `<span class="error">✗ Failed: ${file.name} (${e.message})</span>`;
        }
        status.scrollTop = status.scrollHeight;
    }

    // Database.json güncelleme
    if(newEntries.length > 0) {
        const dbDiv = document.createElement('div');
        dbDiv.className = 'progress-item';
        dbDiv.innerText = "Updating database.json...";
        status.appendChild(dbDiv);

        try {
            const dbPath = "database.json";
            const dbSha = await getSha(dbPath, token);
            let currentDb = [];

            if(dbSha) {
                const dbRes = await fetch(`https://api.github.com/repos/${repo}/contents/${dbPath}`, {
                    headers: { "Authorization": `token ${token}` }
                });
                const dbData = await dbRes.json();
                currentDb = JSON.parse(decodeURIComponent(escape(atob(dbData.content))));
            }

            // Yeni verileri ekle (varsa eskileri güncelle, yoksa ekle)
            newEntries.forEach(entry => {
                const idx = currentDb.findIndex(item => item.name === entry.name && item.category === entry.category);
                if(idx > -1) currentDb[idx] = entry;
                else currentDb.push(entry);
            });

            // Tarihe göre sırala (en yeni en üstte)
            currentDb.sort((a, b) => new Date(b.date) - new Date(a.date));

            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/${dbPath}`, {
                method: "PUT",
                headers: { 
                    "Authorization": `token ${token}`, 
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    message: "Update database.json with new entries and metadata",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(currentDb, null, 2)))),
                    sha: dbSha || undefined
                })
            });

            if(updateRes.ok) {
                dbDiv.innerHTML = `<span class="success">✓ Database updated successfully!</span>`;
            } else {
                throw new Error("Database update failed");
            }
        } catch(e) {
            dbDiv.innerHTML = `<span class="error">✗ Database Error: ${e.message}</span>`;
        }
    }
    
    btn.disabled = false;
    btn.innerText = "START MULTI-UPLOAD & UPDATE DB";
    status.innerHTML += "<br><b>Process completed.</b>";
    status.scrollTop = status.scrollHeight;
}

const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = error => reject(error);
});

async function getSha(path, token) {
    try {
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
            headers: { "Authorization": `token ${token}` }
        });
        if (res.ok) { 
            const data = await res.json(); 
            return data.sha; 
        }
    } catch (e) {}
    return null;
}
</script>
</body>
</html>
